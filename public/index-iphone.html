<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>🚌 BusReserva Pro - Estilo iPhone</title>
    <link rel="stylesheet" href="iphone-styles.css">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="BusReserva Pro">
</head>
<body>
    <!-- Fondo Dinámico iOS -->
    <div class="ios-background"></div>
    
    <div class="container">
        <div class="header fade-in">
            <h1>🚌 BusReserva Pro</h1>
            <p>Reserva tu viaje con estilo</p>
            <div class="subtitle">Diseñado para iPhone • Optimizado para iOS</div>
        </div>

        <div class="tabs slide-up">
            <button class="tab active" onclick="showTab('search')">🔍 Buscar</button>
            <button class="tab" onclick="showTab('register')">👤 Cuenta</button>
            <button class="tab" onclick="showTab('reservations')">🎫 Viajes</button>
            <button class="tab" onclick="showTab('smart')">🧠 Smart</button>
        </div>

        <!-- Búsqueda Inteligente -->
        <div id="search" class="tab-content active">
            <div class="card smart-card slide-up">
                <h2>🔍 Búsqueda Inteligente</h2>
                <div class="grid">
                    <div class="form-group">
                        <label>Origen</label>
                        <select id="origin">
                            <option value="">Seleccionar origen</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Destino</label>
                        <select id="destination">
                            <option value="">Seleccionar destino</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fecha</label>
                        <input type="date" id="date">
                    </div>
                    <div class="form-group">
                        <label>Pasajeros</label>
                        <select id="passengers">
                            <option value="1">1 Pasajero</option>
                            <option value="2">2 Pasajeros</option>
                            <option value="3">3 Pasajeros</option>
                            <option value="4">4 Pasajeros</option>
                        </select>
                    </div>
                </div>
                <button class="btn" onclick="smartSearch()">
                    <span>🔍</span> Buscar Viajes
                </button>
                <button class="btn btn-warning" onclick="getNearbyStations()">
                    <span>📍</span> Estaciones Cercanas
                </button>
            </div>

            <div id="searchResults" class="hidden">
                <div class="card">
                    <h3>✨ Resultados Inteligentes</h3>
                    <div id="tripsList"></div>
                </div>
            </div>
        </div>

        <!-- Registro/Login -->
        <div id="register" class="tab-content">
            <div class="card smart-card slide-up">
                <h2>👤 Tu Cuenta</h2>
                <div id="authSection">
                    <div class="form-group">
                        <label>Nombre Completo</label>
                        <input type="text" id="userName" placeholder="Tu nombre">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="userEmail" placeholder="tu@email.com">
                    </div>
                    <div class="form-group">
                        <label>Teléfono</label>
                        <input type="tel" id="userPhone" placeholder="+34 600 000 000">
                    </div>
                    <div class="form-group">
                        <label>Contraseña</label>
                        <input type="password" id="userPassword" placeholder="Mínimo 6 caracteres">
                    </div>
                    <button class="btn" onclick="registerUser()">
                        <span>✨</span> Crear Cuenta
                    </button>
                    <button class="btn btn-success" onclick="showLoginForm()">
                        <span>🔐</span> Iniciar Sesión
                    </button>
                </div>
            </div>
        </div>

        <!-- Mis Reservas -->
        <div id="reservations" class="tab-content">
            <div class="card smart-card slide-up">
                <h2>🎫 Mis Viajes</h2>
                <div class="form-group">
                    <label>ID de Usuario</label>
                    <input type="number" id="userIdSearch" placeholder="Tu ID">
                    <button class="btn" onclick="loadReservations()">
                        <span>📋</span> Ver Mis Viajes
                    </button>
                </div>
                <div id="reservationsList"></div>
            </div>
        </div>

        <!-- Funciones Smart -->
        <div id="smart" class="tab-content">
            <div class="card smart-card slide-up">
                <h2>🧠 Funciones Inteligentes</h2>
                
                <div class="grid">
                    <div class="smart-feature">
                        <h3>📊 Rutas Populares</h3>
                        <button class="btn btn-success" onclick="loadPopularRoutes()">
                            Ver Tendencias
                        </button>
                        <div id="popularRoutes"></div>
                    </div>
                    
                    <div class="smart-feature">
                        <h3>💰 Predicción de Precios</h3>
                        <select id="routeForPrediction">
                            <option value="">Seleccionar ruta</option>
                        </select>
                        <button class="btn btn-warning" onclick="predictPrice()">
                            Predecir Precio
                        </button>
                        <div id="pricePrediction"></div>
                    </div>
                    
                    <div class="smart-feature">
                        <h3>🎯 Recomendaciones</h3>
                        <input type="number" id="userIdRecommendations" placeholder="Tu ID">
                        <button class="btn btn-success" onclick="getRecommendations()">
                            Ver Recomendaciones
                        </button>
                        <div id="recommendations"></div>
                    </div>
                    
                    <div class="smart-feature">
                        <h3>🔔 Alertas de Precio</h3>
                        <input type="number" id="alertUserId" placeholder="Tu ID">
                        <select id="alertRoute">
                            <option value="">Seleccionar ruta</option>
                        </select>
                        <input type="number" id="priceThreshold" placeholder="Precio máximo €">
                        <button class="btn btn-danger" onclick="setUpAlert()">
                            Configurar Alerta
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="notifications"></div>
    </div>

    <script>
        // Variables globales
        let currentUser = null;
        let ws = null;

        // Inicializar WebSocket
        function initWebSocket() {
            ws = new WebSocket(`ws://localhost:3000`);
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                showNotification(data.message, data.type);
            };
            
            ws.onclose = () => {
                setTimeout(initWebSocket, 5000); // Reconectar
            };
        }

        // Configurar fecha mínima
        document.getElementById('date').min = new Date().toISOString().split('T')[0];

        // Funciones de navegación
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => {
                t.classList.remove('active');
                t.style.opacity = '0';
            });
            
            event.target.classList.add('active');
            
            setTimeout(() => {
                const content = document.getElementById(tabName);
                content.classList.add('active');
                content.style.opacity = '1';
            }, 150);
        }

        // Notificaciones estilo iOS
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'ios-notification';
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 1.2rem;">${getIcon(type)}</span>
                    <span style="flex: 1; font-weight: 500;">${message}</span>
                    <button onclick="this.closest('.ios-notification').remove()" 
                            style="background: none; border: none; font-size: 1.2rem; cursor: pointer;">×</button>
                </div>
            `;
            
            document.getElementById('notifications').appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'slideInRight 0.3s ease reverse';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        function getIcon(type) {
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };
            return icons[type] || icons.info;
        }

        // Búsqueda inteligente
        async function smartSearch() {
            const origin = document.getElementById('origin').value;
            const destination = document.getElementById('destination').value;
            const date = document.getElementById('date').value;
            const passengers = document.getElementById('passengers').value;

            if (!origin || !destination || !date) {
                showNotification('Completa todos los campos', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/search?origin=${origin}&destination=${destination}&date=${date}&passengers=${passengers}`);
                const trips = await response.json();

                displayTrips(trips);
                document.getElementById('searchResults').classList.remove('hidden');
            } catch (error) {
                showNotification('Error en la búsqueda', 'error');
            }
        }

        // Mostrar viajes con diseño iOS
        function displayTrips(trips) {
            const container = document.getElementById('tripsList');
            
            if (trips.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #8E8E93;">No se encontraron viajes</p>';
                return;
            }

            container.innerHTML = trips.map(trip => `
                <div class="trip-card">
                    <div class="trip-header">
                        <div class="trip-route">${trip.origin} → ${trip.destination}</div>
                        <div class="trip-price">€${trip.price}</div>
                    </div>
                    <div class="trip-details">
                        <div class="trip-detail">
                            <div class="trip-detail-label">Salida</div>
                            <div class="trip-detail-value">${trip.departure_time}</div>
                        </div>
                        <div class="trip-detail">
                            <div class="trip-detail-label">Llegada</div>
                            <div class="trip-detail-value">${trip.arrival_time}</div>
                        </div>
                        <div class="trip-detail">
                            <div class="trip-detail-label">Autobús</div>
                            <div class="trip-detail-value">${trip.bus_number}</div>
                        </div>
                        <div class="trip-detail">
                            <div class="trip-detail-label">Asientos</div>
                            <div class="trip-detail-value">${trip.available_seats}</div>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="reserveTrip(${trip.id}, ${trip.price})" 
                            style="width: 100%; margin-top: 16px;">
                        🎫 Reservar Ahora
                    </button>
                </div>
            `).join('');
        }

        // Funciones inteligentes
        async function loadPopularRoutes() {
            try {
                const response = await fetch('/api/analytics/popular-routes');
                const routes = await response.json();
                
                const container = document.getElementById('popularRoutes');
                container.innerHTML = routes.map(route => `
                    <div style="padding: 12px; background: rgba(0, 122, 255, 0.1); border-radius: 8px; margin: 8px 0;">
                        <strong>${route.origin} → ${route.destination}</strong><br>
                        <small>${route.bookings} reservas • €${route.avg_price} promedio</small>
                    </div>
                `).join('');
            } catch (error) {
                showNotification('Error cargando rutas populares', 'error');
            }
        }

        async function predictPrice() {
            const routeId = document.getElementById('routeForPrediction').value;
            if (!routeId) return;

            try {
                const response = await fetch(`/api/price-prediction/${routeId}`);
                const prediction = await response.json();
                
                const container = document.getElementById('pricePrediction');
                container.innerHTML = `
                    <div style="padding: 16px; background: rgba(52, 199, 89, 0.1); border-radius: 12px; margin-top: 12px;">
                        <h4>💰 Predicción de Precio</h4>
                        <p><strong>Precio actual:</strong> €${prediction.current_price}</p>
                        <p><strong>Precio predicho:</strong> €${prediction.predicted_price}</p>
                        <p><strong>Demanda:</strong> ${prediction.demand_level}</p>
                        <p><strong>Recomendación:</strong> ${prediction.recommendation === 'book_now' ? '📈 Reservar ahora' : '⏳ Esperar'}</p>
                    </div>
                `;
            } catch (error) {
                showNotification('Error en predicción', 'error');
            }
        }

        async function getNearbyStations() {
            if (!navigator.geolocation) {
                showNotification('Geolocalización no disponible', 'error');
                return;
            }

            navigator.geolocation.getCurrentPosition(async (position) => {
                const { latitude, longitude } = position.coords;
                
                try {
                    const response = await fetch(`/api/nearby-stations?lat=${latitude}&lng=${longitude}`);
                    const stations = await response.json();
                    
                    showNotification(`Encontradas ${stations.length} estaciones cercanas`, 'success');
                    
                    // Actualizar selectores con estaciones cercanas
                    const originSelect = document.getElementById('origin');
                    stations.forEach(station => {
                        const option = new Option(`📍 ${station.station} (${station.distance.toFixed(1)}km)`, station.station);
                        originSelect.add(option);
                    });
                } catch (error) {
                    showNotification('Error obteniendo estaciones', 'error');
                }
            });
        }

        // Registro de usuario
        async function registerUser() {
            const userData = {
                name: document.getElementById('userName').value,
                email: document.getElementById('userEmail').value,
                phone: document.getElementById('userPhone').value,
                password: document.getElementById('userPassword').value
            };

            if (!userData.name || !userData.email || !userData.password) {
                showNotification('Completa todos los campos obligatorios', 'error');
                return;
            }

            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    currentUser = result;
                    showNotification(`¡Cuenta creada! Tu ID es: ${result.id}`, 'success');
                    clearForm();
                } else {
                    showNotification(result.error, 'error');
                }
            } catch (error) {
                showNotification('Error creando cuenta', 'error');
            }
        }

        function clearForm() {
            document.getElementById('userName').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('userPhone').value = '';
            document.getElementById('userPassword').value = '';
        }

        // Inicializar aplicación
        document.addEventListener('DOMContentLoaded', function() {
            initWebSocket();
            loadCities();
            
            // Animaciones de entrada
            const elements = document.querySelectorAll('.card, .tabs');
            elements.forEach((element, index) => {
                setTimeout(() => {
                    element.style.opacity = '0';
                    element.style.transform = 'translateY(20px)';
                    element.style.transition = 'all 0.6s ease';
                    
                    setTimeout(() => {
                        element.style.opacity = '1';
                        element.style.transform = 'translateY(0)';
                    }, 100);
                }, index * 100);
            });
        });

        async function loadCities() {
            try {
                const response = await fetch('/api/cities');
                const cities = await response.json();
                
                const originSelect = document.getElementById('origin');
                const destinationSelect = document.getElementById('destination');
                
                cities.forEach(city => {
                    originSelect.add(new Option(city, city));
                    destinationSelect.add(new Option(city, city));
                });
            } catch (error) {
                console.error('Error loading cities:', error);
            }
        }
    </script>
</body>
</html>